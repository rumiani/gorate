name: "Deploy gorate to my VPS"

on:
  push:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image to DockerHub
        run: |
          docker build -t maziarrumiani/gorate:latest ./
          docker push maziarrumiani/gorate:latest

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add VPS to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.SSH_HOST }} "
            set -e  # stop if any command fails

            # ensure deploy directory exists
            mkdir -p /home/deploy/gorate
            cd /home/deploy/gorate

            # clone or update repo
            if [ ! -d .git ]; then
              git clone https://github.com/rumiani/gorate.git .
            else
              git fetch origin master
              git reset --hard origin/master
            fi

            # pull latest Docker image
            docker pull maziarrumiani/gorate:latest

            # stop and remove old container (if any)
            docker stop gorate-bot-1 || true
            docker rm gorate-bot-1 || true

            # run new container with GitHub secrets as env vars
            docker run -d \
              --name gorate-bot-1 \
              -e ENV=prod \
              -e PROD_BOT_TOKEN='${{ secrets.PROD_BOT_TOKEN }}' \
              -e DATABASE_URL='${{ secrets.DATABASE_URL }}' \
              maziarrumiani/gorate:latest
          "
